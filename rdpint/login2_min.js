function showTwoFAQR(q,r){var t=hi5.$("twofainfo");if(t){var p=hi5.$("barcodeDiv"),k=hi5.$("enableTwoFA"),n=hi5.$("disableTwoFA");r?(hi5.$("imgBarcode").src="data:image/png;base64,"+r,p.style.display="block",n.style.display="none",k.style.display="block"):(p.style.display="none",n.style.display="block",k.style.display="none");var u=new hi5.ui.Lightbox(t);u.show();hi5.$("faCode").focus();hi5.$("faCode").value="";k.onclick=n.onclick=function(a){var b=hi5.$("faCode").value;a=a.target==k?1:0;6!=b.length?
hi5.notifications.notify(__svi18n.info.digit6||"It must be a 6 digit number"):(q(b,a),u.dismiss())}}}
svGlobal.auth=new function(){var q=this;this.getLoginURL=function(){return("https:"==location.protocol?"wss://":"ws://")+hi5.$("gateway").value+"/LOGIN?"};this.login=function(r){function t(n,u){window.__sparkUser=null;if(!q.beforelogin||!q.beforelogin(n)){var a=new WebSocket(n.substring(0,n.indexOf("?"))+"?_METHOD=post","login");a.onclose=function(b){q.afterlogin&&q.afterlogin(p);p=!1};a.onopen=function(b){p=!0};a.onmessage=function(b){var d=b.data,c=d.substring(0,2);if("00"==c)a.send("00"+n.substring(n.indexOf("?")+
1));else if("01"==c)switch(hi5.tool.enableInput(),d.substring(2,3)){case "0":if(b=hi5.$("twofacode")){var f=new hi5.ui.Lightbox(b);f.show();var m=hi5.$("btnTwoFACode"),e=hi5.$("faAuthCode");e.focus();e.value="";m.onclick=function(){a.send("code:"+e.value);f.dismiss()};e.addEventListener("keyup",function(g){if(13==g.keyCode||"Enter"==g.code)g.preventDefault(),m.click()})}break;case "1":b=d.substring(4),showTwoFAQR(function(g,l){a.send("code:"+g)},b)}else b=JSON.parse(b.data),0===b.type&&(b.message||
b.name)?svGlobal.gatewayError(b.name,b.message||b.msg):(b.error||a.send("A1"+navigator.userAgent),u(b))}}}var p=!1,k=hi5.browser.cookie2Obj();k.svSession&&k.svEmail&&(r+="&svSession="+k.svSession+"&svEmail="+encodeURIComponent(k.svEmail));setTimeout(function(){t(r,svGlobal.onloggedin)},5);return!1}};
function startExitingApp(q){function r(n){t.addSurface(n);t.startExitingApp(q)}var t=svManager.getInstance();window.svOnSurfaceReady=r;window.open("rail.html").svOnSurfaceReady=r;var p=hi5.$(q),k=p.parentNode;k.removeChild(p);k=k.parentNode;0==k.getElementsByTagName("input").length&&(k.dismiss(),t.checkRemaining(2E3))}function getLoginURL(){return("https:"==location.protocol?"wss://":"ws://")+hi5.$("gateway").value+"/LOGIN?"}
window.addEventListener("load",function(q){function r(){q.preventDefault();svGlobal.auth.beforesubmit&&svGlobal.auth.beforesubmit();var a=hi5.$("frmLogin").elements,b=a.user.value,d=a.pwd.value;b=getLoginURL()+"user="+encodeURIComponent(b)+"&pwd="+encodeURIComponent(d);(a=a.sharedSecret)&&a.value&&(b+="&sharedSecret="+encodeURIComponent(a.value));return svGlobal.auth.login(b)}function t(a,b){var d=svGlobal.auth.getLoginURL()+"action=code",c=new WebSocket(d,"login");c.onmessage=function(f){f=JSON.parse(f.data);
f.error?svGlobal.gatewayError(f.name,f.message||f.msg):hi5.notifications.notify(__svi18n.info.succeeded);c.close()};c.onopen=function(f){c.send("twof:"+a+"\t"+__sparkUser.account+"\t"+b+"\t"+__sparkUser.session)}}function p(){window.__sparkUser=null;var a=hi5.$("frmLogin");a.elements.pwd.value="";a.style.display="block";hi5.$("frmConn").style.display="none";(a=svManager.getInstance())&&a.running()&&a.close()}function k(a){var b=a.target;b.onclick=null;setTimeout(function(){b.onclick=k},300);u(b.id)}
function n(){function a(c){d.addSurface(c);c=b.exe||b.rdp.remoteProgram;var f=b.args||b.rdp.remoteArgs||"";console.log("remoteApp: "+c+" arg="+f+" running="+d.running());d.running()?d.startApp(c,f,""):d.run()}var b=window.__sparkUser.server,d=svManager.getInstance();null==d&&(d=new svGlobal.Rdp2(b),d.sessionTimeout=9E5);window.svOnSurfaceReady=a;window.open("rail.html").svOnSurfaceReady=a}function u(a,b,d){var c=window.__sparkUser,f=c.servers,m=f.length;c.server=null;window.sparkGateway=c.gateway;
for(var e=0;e<m;e++){var g=f[e];if(a==g.id){g.gateway=c.gateway;g.session=c.session;g.account=c.account;c.server=g;break}}if(c.server){console.log("connecting to:"+c.server.id);(a=hi5.$("touchpad"))&&a.checked&&(c.server.touchpad=!0);if(a=hi5.$("keyboard"))a=parseInt(a.options[a.selectedIndex].value),0<a&&(c.server.keyboard=a);"undefined"==typeof b&&(b=(a=hi5.$("sameWindow"))&&a.checked);b&&!c.server.rdp&&(b=!1);c.server.rdp&&c.server.rdp.remoteProgram&&(c.server.startProgram="app");a="width="+window.outerWidth+
",height="+window.outerHeight;c.server.http&&window.open("/PXY/"+c.server.id+"/","new-window",a);if("app"==c.server.startProgram&&hi5.browser.isMultitask&&!b)n();else if(b){var l=new Rdp2(c.server);hi5.$("login").style.display="none";l.addSurface(new svGlobal.LocalInterface);l.run();l.onclose=function(){if(d){window.__sparkUser=null;var h=hi5.$("frmLogin");h.elements.pwd.value="";h.style.display="block";hi5.$("frmConn").style.display="none"}else l.hide(),hi5.$("login").style.display="block"}}else b=
document.getElementById("multiMon"),c.server.rdp?(c.server.rdp.multiMon=b&&b.checked?"on":"off",window.open("rdpdirect.html","new-window",a)):c.server.vnc?window.open("vnc.html","new-window",a):c.server.ssh?window.open("sshdirect.html","new-window",a):c.server.telnet&&window.open("telnet.html","new-window",a)}else hi5.notifications.notify("Not a valid server")}svGlobal.auth.beforelogin=function(){hi5.tool.disableInput()};svGlobal.auth.afterlogin=function(a){a||(hi5.notifications.notify(__svi18n.errorCode.connection),
p());hi5.tool.enableInput()};svGlobal.onloggedin=function(a){hi5.tool.enableInput();if(a.error)svGlobal.gatewayError(a.name,a.message||a.msg);else{hi5.$("frmLogin").style.display="none";hi5.$("frmConn").style.display="block";for(var b=hi5.$("programs");b.hasChildNodes();)b.removeChild(b.firstChild);var d=a.servers;if(!a.accessNotInList){var c=hi5.$("anyconn");c&&(c.style.display="none")}c=hi5.$("user").value;hi5.appcfg&&hi5.appcfg.domain&&hi5.appcfg.hiddenDomain&&(c=hi5.appcfg.domain+"\\"+c);window.__sparkUser=
{session:a.session,account:c,gateway:hi5.$("gateway").value,servers:d,twoFA:a.twoFA,twoFAEnabled:a.twoFAEnabled,twoFAQR:a.twoFAQR};a=d.length;if(!(1>a)){c="";for(var f=0;f<a;f++){var m=d[f].server,e=d[f].id;m=d[f].displayName||e||m;var g=d[f].icon;g||(g="rdp32.png");var l=document.createElement("div");l.className="icon";var h=document.createElement("img");h.src=g;h.id=e;h.alt=e;h.title=m;h.style.cursor="pointer";h.onclick=k;l.appendChild(h);l.appendChild(document.createElement("br"));l.appendChild(document.createTextNode(m));
b.appendChild(l);hi5.appcfg.startup&&e===hi5.appcfg.startup.server&&(c=e)}!c&&hi5.appcfg.startup&&(console.log("start up:"+hi5.appcfg.startup.server+" not found, use the first instead"),c=d[0].id);c&&u(c,!hi5.appcfg.startup.newWindow,!0)}}};(function(){hi5.$("user").focus();hi5.$("frmLogin").onsubmit=r;var a=hi5.$("anyconn");a&&(a.onclick=function(){var e="width="+window.outerWidth+",height="+window.outerHeight;window.open("rdp.html?gateway="+hi5.$("gateway").value,"new-window",e)});if(a=document.querySelector('input[name="showlogin"]'))a.onclick=
p;a=hi5.browser.cookie2Obj();var b=-1!=document.cookie.indexOf("__SV_TOKEN_A"),d=hi5.tool.queryToObj();if(a.svEmail||a.user||b||d.autoLogin||d.user&&d.pwd){var c=hi5.$("frmLogin").elements;c.user.value=a.svEmail||a.user||d.user||"";c.pwd.value=(a.svSession?"fake":a.pwd)||d.pwd||"_";a.gateway&&(c.gateway.value=a.gateway);(c.user.value&&c.pwd.value||a.autoLogin||b||d.autoLogin)&&setTimeout(r,30)}a=hi5.$("settings");var f=hi5.$("settingsDiv");a&&(a.onclick=function(){if(f){(new hi5.ui.Lightbox(f)).show();
hi5.$("currPwd").focus();var e=hi5.$("btnTwoFA");e&&(e.onclick=function(){showTwoFAQR(t,window.__sparkUser.twoFAQR)},0==__sparkUser.twoFA&&e.parentNode.removeChild(e))}});if(a=hi5.$("frmSettings"))a.onsubmit=function(e){e.preventDefault();var g=e.target.elements;if(g.newPwd1.value!=g.newPwd2.value)hi5.notifications.notify(__svi18n.errorCode.pwdmatch);else{e=getLoginURL()+"_METHOD=post&action=put";var l=new WebSocket(e,"login");l.onmessage=function(h){0==h.data.indexOf("00")?(l.send("00currPwd="+encodeURIComponent(g.currPwd.value)+
"&newPwd="+encodeURIComponent(g.newPwd1.value)+"&user="+encodeURIComponent(hi5.$("user").value)),hi5.$("frmSettings").reset()):(h=JSON.parse(h.data),h.error&&svGlobal.gatewayError(h.name,h.message||h.msg))};f.dismiss&&f.dismiss();return!1}};var m=hi5.$("sameWindow");m&&(hi5.browser.isiOS||hi5.browser.isIE||hi5.browser.isChromeApp)&&(m.checked=!0);(a=hi5.$("multiMon"))&&m&&(a.onchange=function(e){e.target.checked&&(m.checked=!1)});a=hi5.$("gateway");(b=a.value)||(b=hi5.appcfg.defaultPort?window.location.hostname+
":"+hi5.appcfg.defaultPort:window.location.host);0==b.length&&(b="localhost");a.value=b;a=hi5.$("touchpadmode");hi5.browser.isTouch&&(a.style.display="");(a=hi5.$("user"))&&!a.value&&hi5.appcfg&&hi5.appcfg.domain&&(a.value=hi5.appcfg.domain+"\\");(function(){var e=!1,g="";try{document.createElement("canvas").getContext("2d"),e=!0}catch(w){g="This browser does not support Canvas.\n\n"}var l=!("WebSocket"in window)&&!("MozWebSocket"in window),h=navigator.userAgent,v=-1!=h.indexOf("Firefox");l&&(g+=
"This browser doesn't support WebSocket.\n\n",v?g+="Please update to Firefox 6 or later.\n\n":-1!=h.indexOf("Opera")?g+="Please open 'opera:config#Enable WebSockets' (type it in the link field) make 'Enable WebSockets' selected and restart Opera.\n\n":-1!=h.indexOf("MSIE")&&(g+="Please install Google Chrome Frame.\n\n"));0<g.length&&hi5.notifications.notify(g);return!l&&e})();(a=hi5.$("defPort"))&&hi5.appcfg.defaultPort&&(a.innerHTML=hi5.appcfg.defaultPort);(a=document.getElementById("frmConn"))&&
(a=a.querySelector('select[name="keyboard"]'));a&&(b=svGlobal.Rdp.languageToKeyboard.detect())&&(a.value=b)})()},!1);
