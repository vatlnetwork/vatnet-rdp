svGlobal.Player=function(k){function D(){g=m=h=0;p=c=null;n=!1;a.state=a.CLOSED;g=m=h=0;p=c=null;n=!1}function v(d,b){return(d[b]&255)<<24|(d[b+1]&255)<<16|(d[b+2]&255)<<8|d[b+3]&255}function G(){m+=w;a.onprogress(m,h)}function H(d,b){if(a.state!=a.PLAYING)g-=8;else{var e=d.target.result;d=function(){x&&(clearInterval(x),x=0);if(a.onprogress)a.onprogress(b,h);m=b;if(a.state==a.PLAYING){g+=e.byteLength;var l=new Uint8Array(e.slice(0,1));if(66>l)if(y){if(48==l[0])a.onmessage({data:e.slice(2)})}else a.onmessage({data:e});
q(8,z)}else g-=8};if(a.state==a.PLAYING){var f=n?0:b-m;if(10>f||0==m)f=0;n&&0<r&&b>=r&&(c.getDesktop&&c.getDesktop().pause(!1),n=!1,r=0);0<f?p=setTimeout(d,f):d();f>3*w&&(x=setInterval(G,w))}}}function z(d){if(a.state==a.PLAYING){var b=new Int8Array(d.target.result);if(b&&8==b.length){d=v(b,0);var e=v(b,4);0>e&&(console.error("Duration:"+e),e=0);b=function(f){E=e;H(f,e)};a.state==a.PLAYING&&(g+=8,q(d,b))}else{if(a.onprogress)a.onprogress(h,h);a.close()}}}function F(d){var b=new Int8Array(d.target.result);
t=String.fromCharCode(b[0],b[1],b[2],b[3]);d=(b[4]&255)<<8|b[5]&255;var e=(b[6]&255)<<8|b[7]&255,f=(b[8]&255)<<8|b[9]&255,l=b[10]&255;m=0;h=v(b,19)<<32|v(b,23);console.log("total time:"+h+" type:"+t+" width:"+e+" height:"+f+" color:"+l);if(e&&f){w=h/100|0;if(c&&c.running())c.resetStatus&&c.resetStatus();else if("RDPV"==t)(b=svManager.getInstance())&&b.close(),c=new svGlobal.Rdp(a,e,f,l),c.displayMsg=!1,c.setTitle=!1,c.addSurface(k),c.run();else if("VNCV"==t)(b=svManager.getInstance())&&b.close(),
c=new svGlobal.Vnc(a,e,f,l),c.displayMsg=!1,c.setTitle=!1,c.addSurface(k),c.run();else if("SSHV"==t)y=!0,(b=svManager.getInstance())&&b.close(),c=new svGlobal.SSH(a,e,f,l),c.displayMsg=!1,c.setTitle=!1,c.addSurface(k),c.run();else if("TELV"==t)y=!0,(b=svManager.getInstance())&&b.close(),c=new svGlobal.TELNET(a,e,f,l),c.displayMsg=!1,c.setTitle=!1,c.addSurface(k),c.run();else{hi5.notifications.notify("Invalid format!");return}if(a.onopen)a.onopen();if(a.onopened)a.onopened({width:e,height:f,color:l,
version:d,length:h,size:A.size});g=64;0<r&&c.getDesktop&&c.getDesktop().pause(!0);q(8,z)}else hi5.notifications.notify("Invalid resolution, width:"+e+" height:"+f)}function q(d,b){if(a.state!=a.PLAYING){if(8==d)return;g-=8}B?(d=A.slice(g,g+d),u=new FileReader,u.onload=b,u.readAsArrayBuffer(d)):(g=0,B=!0,q(64,F))}var a=this,g=0,m=0,h=0,w=0,x=0,A=null,p=null,c=null,u=null,n=!1,C=!1,r=0,t="",y=!1;this.PLAYING=0;this.PAUSED=1;this.CLOSED=3;var E=0;this.state=this.CLOSED;var B=!0;k||(k=new svGlobal.LocalInterface);
k.setReadOnly(!0);k.hideWhenClose=!1;this.getSurface=function(){return k};this.close=function(){console.log("Player closed");try{if(a.onclose&&(a.onclose({code:0,reason:""}),a.onclose=null),c&&(c.close(),c=null),a.onend)a.onend()}finally{D()}};this.setSource=function(d){if(u){try{u.abort()}catch(b){}u=null}a.state==a.PLAYING?(a.state=a.CLOSED,C=!0,p&&(clearTimeout(p),p=null),a.close()):(D(),C=!1);if(d){if(!("slice"in d||(d.slice=d.webkitSlice||d.mozSlice,"slice"in d))){alert(__svi18n.file.slice);
return}A=d}else alert(__svi18n.player.noinput)};this.send=function(){};this.play=function(){a.state=a.PLAYING;if(0==g){var d=function(){g=0;q(64,F)};C?setTimeout(d,888):d()}else q(8,z)};this.scan=function(d){n=d};this.pause=function(){a.state=a.PAUSED};this.seek=function(d){c&&(n=!0,c.getDesktop&&c.getDesktop().pause(!0),r=parseInt(h*d/100),r<E&&(B=!1))};this.setVolume=function(d){c&&c.setVolume&&c.setVolume(d)}};svGlobal.RdpPlayer=svGlobal.Player;
