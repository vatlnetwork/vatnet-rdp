svGlobal.Player=function(k){function D(){g=l=h=0;n=c=null;m=!1;a.state=a.CLOSED;g=l=h=0;n=c=null;m=!1}function v(d,b){return(d[b]&255)<<24|(d[b+1]&255)<<16|(d[b+2]&255)<<8|d[b+3]&255}function G(){l+=w;a.onprogress(l,h)}function H(d,b){if(a.state!=a.PLAYING)g-=8;else{var e=d.target.result;d=function(){x&&(clearInterval(x),x=0);if(a.onprogress)a.onprogress(b,h);l=b;if(a.state==a.PLAYING){g+=e.byteLength;if(y){if(48==(new Uint8Array(e.slice(0,1)))[0])a.onmessage({data:e.slice(2)})}else a.onmessage({data:e});
p(8,z)}else g-=8};if(a.state==a.PLAYING){var f=m?0:b-l;if(10>f||0==l)f=0;m&&0<q&&b>=q&&(c.getDesktop&&c.getDesktop().pause(!1),m=!1,q=0);0<f?n=setTimeout(d,f):d();f>3*w&&(x=setInterval(G,w))}}}function z(d){if(a.state==a.PLAYING){var b=new Int8Array(d.target.result);if(b&&8==b.length){d=v(b,0);var e=v(b,4);0>e&&(console.error("Duration:"+e),e=0);b=function(f){E=e;H(f,e)};a.state==a.PLAYING&&(g+=8,p(d,b))}else{if(a.onprogress)a.onprogress(h,h);a.close()}}}function F(d){var b=new Int8Array(d.target.result);
r=String.fromCharCode(b[0],b[1],b[2],b[3]);d=(b[4]&255)<<8|b[5]&255;var e=(b[6]&255)<<8|b[7]&255,f=(b[8]&255)<<8|b[9]&255,t=b[10]&255;l=0;h=v(b,19)<<32|v(b,23);console.log("total time:"+h+" type:"+r+" width:"+e+" height:"+f+" color:"+t);if(e&&f){w=h/100|0;if(c&&c.running())c.resetStatus&&c.resetStatus();else if("RDPV"==r)(b=svManager.getInstance())&&b.close(),c=new svGlobal.Rdp(a,e,f,t),c.displayMsg=!1,c.setTitle=!1,c.addSurface(k),c.run();else if("VNCV"==r)(b=svManager.getInstance())&&b.close(),
c=new svGlobal.Vnc(a,e,f,t),c.displayMsg=!1,c.setTitle=!1,c.addSurface(k),c.run();else if("SSHV"==r)y=!0,(b=svManager.getInstance())&&b.close(),c=new svGlobal.SSH(a,e,f,t),c.displayMsg=!1,c.setTitle=!1,c.addSurface(k),c.run();else if("TELV"==r)y=!0,(b=svManager.getInstance())&&b.close(),c=new svGlobal.TELNET(a,e,f,t),c.displayMsg=!1,c.setTitle=!1,c.addSurface(k),c.run();else{hi5.notifications.notify("Invalid format!");return}if(a.onopen)a.onopen();if(a.onopened)a.onopened({width:e,height:f,color:t,
version:d,length:h,size:A.size});g=64;0<q&&c.getDesktop&&c.getDesktop().pause(!0);p(8,z)}else hi5.notifications.notify("Invalid resolution, width:"+e+" height:"+f)}function p(d,b){if(a.state!=a.PLAYING){if(8==d)return;g-=8}B?(d=A.slice(g,g+d),u=new FileReader,u.onload=b,u.readAsArrayBuffer(d)):(g=0,B=!0,p(64,F))}var a=this,g=0,l=0,h=0,w=0,x=0,A=null,n=null,c=null,u=null,m=!1,C=!1,q=0,r="",y=!1;this.PLAYING=0;this.PAUSED=1;this.CLOSED=3;var E=0;this.state=this.CLOSED;var B=!0;k||(k=new svGlobal.LocalInterface);
k.setReadOnly(!0);k.hideWhenClose=!1;this.getSurface=function(){return k};this.close=function(){console.log("Player closed");try{if(a.onclose&&(a.onclose({code:0,reason:""}),a.onclose=null),c&&(c.close(),c=null),a.onend)a.onend()}finally{D()}};this.setSource=function(d){if(u){try{u.abort()}catch(b){}u=null}a.state==a.PLAYING?(a.state=a.CLOSED,C=!0,n&&(clearTimeout(n),n=null),a.close()):(D(),C=!1);if(d){if(!("slice"in d||(d.slice=d.webkitSlice||d.mozSlice,"slice"in d))){alert(__svi18n.file.slice);
return}A=d}else alert(__svi18n.player.noinput)};this.send=function(){};this.play=function(){a.state=a.PLAYING;if(0==g){var d=function(){g=0;p(64,F)};C?setTimeout(d,888):d()}else p(8,z)};this.scan=function(d){m=d};this.pause=function(){a.state=a.PAUSED};this.seek=function(d){c&&(m=!0,c.getDesktop&&c.getDesktop().pause(!0),q=parseInt(h*d/100),q<E&&(B=!1))};this.setVolume=function(d){c&&c.setVolume&&c.setVolume(d)}};svGlobal.RdpPlayer=svGlobal.Player;
